<html>
<head> 
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="codemirror.js"></script>
<link rel="stylesheet" href="codemirror.css" />

<style>
span.space { background: lightgray }
span.word { background: pink }
span.indent { background: lightblue }
span.other { }
</style>

<script>
$(function() { 

var magicTokenMode = function(options) {
    var startState = options.startState || function() { return null };
    var copyState = function(s) { return CodeMirror.copyState(options, s) };
    

    var changeDisabled = false;
    return {
        startState: function() {
            return { token: null, state: (options.startState || function() { return null })() }
        },
        copyState: function(state) {
            return { token: state.token, state: copyState(state.state) }
        },
        token: function(stream, state) {
            var tok = options.token(stream, state.state);
            if (tok === null || tok === undefined) {
                return state.token = null;
            }
            if (typeof(tok) === 'string') {
                state.token = { 'class': tok };
                return tok;
            }
            if (typeof(tok) === 'object') {
                state.token = tok;
                return tok['class'];
            }
            throw "Bad return value from token: " + tok;
        },
        onChange: function(mirror, change) {
            if (changeDisabled) return;
            
            var mtok = mirror.getTokenAt(change.to);
            if (!mtok) return;
            var tok = mtok.state.token;
            if (!tok) return;
            if (change.text[0] === "" && change.from.line == change.to.line && change.from.ch == change.to.ch) { 
                console.log("Newline", change)
            }
            else if (typeof(tok.text) === 'string' && tok.text != mtok.string) {
                var oldChangeDisabled = changeDisabled;
                changeDisabled = true;
                mirror.replaceRange(tok.text, { line: change.from.line, ch: mtok.start }, { line: change.from.line, ch: mtok.end });
                changeDisabled = oldChangeDisabled;
            }
        },
    }
};

var alty = magicTokenMode({
    token: function(stream, state) {
        if (stream.match(/^\s+/)) {
            return { 'class': 'space', text: ' ' };
        }
        if (stream.match(/^\w+/)) {
            return { 'class': 'word', text: 'word' };
        }
        if (stream.match(/^:/)) {
            return { 'class': 'indent', text: ':\n    ' };
        }
        stream.eatWhile(/^.*/);
        return 'other';
    }
});

CodeMirror.defineMode("alty", function(conifg, parserConfig) {
    return alty;
});

mirror = CodeMirror(document.body, {
    onChange: alty.onChange
});

});
</script>  
</head>
<body>
</body>
</html>
