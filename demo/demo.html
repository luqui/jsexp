<html>
<head> 
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="codemirror.js"></script>
<link rel="stylesheet" href="codemirror.css" />
<script src="../earley.js"></script>

<style>
span.elit    { color: red }
span.plusop  { color: blue }
span.timesop { color: blue }
span.derefop { color: black; font-weight: bold }
span.etimes  { background: #ddd }
span.error   { background: red; color: white }
</style>

<script>
$(function() { 

// CodeCatalog Snippet http://www.codecatalog.net/279/1/
var foreach = function(array, body) {
    for (var i = 0; i < array.length; ++i) {
        body(array[i]);
    }
};
// End CodeCatalog Snippet

var grammar = {
    'E':       [ [ 'eplus'  ] ],
    'eplus':   [ [ 'etimes' ], [ 'eplus', 'plusop', 'etimes' ] ],
    'etimes':  [ [ 'eatom' ], [ 'etimes', 'timesop', 'eatom' ] ],
    'eatom':   [ [ 'elit'   ], [ /^\(/, 'eplus', /^\)/ ], [ 'derefop', 'eatom' ], ['elist'] ],
    'elit':    [ [ /^\d+/   ], [ /^"([^\\"]*\\.)*[^\\"]*"/ ] ],
    'elist':   [ [ /^\[/, 'elistexpr', /^\]/ ] ],
    'elistexpr': [ [ ], [ 'elistitem' ] ],
    'elistitem': [ [ 'elistitem', /^,/, 'eplus' ], [ 'eplus' ] ],
    'plusop':  [ [ /^[+-]/  ] ],
    'timesop': [ [ /^[*\/]/ ] ],
    'derefop': [ [ /^\*/ ] ],
};

CodeMirror.defineMode("alty", function(conifg, parserConfig) {
    var findHead = function(set, list) {
        for (var i = 0; i < list.length; i++) {
            if (list[i].head in set) return list[i].head;
        }
        return null;
    };

    return {
        startState: function() {
            return { state: EarleyParser(grammar, 'E') }
        },
        copyState: function(state) {
            return { state: state.state }
        },
        token: function(stream, state) {
            for (var i = 0; i < state.state.length; ++i) {
                var p = state.state[i];
                var m = stream.match(p.symbol);
                if (m) {
                    state.state = p.consume(m[0]);
                    var cx = p.context();
                    return findHead({ 'elit': 1, 'plusop':1, 'timesop':1, 'derefop':1 }, cx);
                }
            }
            stream.eatWhile(function() { return true });
            return 'error';
        }
    }
});

CodeMirror(document.body);

});
</script>  
</head>
<body>
</body>
</html>
