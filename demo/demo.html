<html>
<head> 
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="codemirror.js"></script>
<link rel="stylesheet" href="codemirror.css" />
<script src="../sexp.js"></script>
<script src="../earley.js"></script>
<script src="../attribute_grammar.js"></script>

<style>
span.ref     { color: green }
span.param   { color: blue }
span.error   { background: red; color: white }
</style>

<script>
$(function() { 

// CodeCatalog Snippet http://www.codecatalog.net/279/1/
var foreach = function(array, body) {
    for (var i = 0; i < array.length; ++i) {
        body(array[i]);
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/323/2/
var for_kv = function(object, body) {
    for (var k in object) {
        if (object.hasOwnProperty(k)) {
            body(k, object[k]);
        }
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/183/1/
var keys = function(obj) {
    var r = [];
    for (var key in obj) {
        r.push(key);
    }
    return r;
};
// End CodeCatalog Snippet

var grammar = {
    'E':       [ [ 'stmts' ] ],
    'stmts':   [ [ 'stmt', /^;/, 'stmts' ], [ ] ],
    'stmt':    [ [ 'scope' ], [ 'ref' ] ],
    'scope':   [ [ /^\{/, 'param', 'stmts', /^\}/ ] ],
    'param':   [ [ ], [ /^\|/, /^\w+/, /^\|/ ] ],
    'ref':     [ [ /^\w+/ ] ],
};

CodeMirror.defineMode("alty", function(conifg, parserConfig) {
    var findHead = function(set, list) {
        for (var i = 0; i < list.length; i++) {
            if (list[i].head in set) return list[i].head;
        }
        return null;
    };

    return {
        startState: function() {
            return { state: EarleyParser(grammar, 'E') }
        },
        copyState: function(state) {
            return { state: state.state }
        },
        token: function(stream, state) {
            for (var i = 0; i < state.state.length; ++i) {
                var p = state.state[i];
                var m = stream.match(p.symbol);
                if (m) {
                    state.state = p.consume(m[0]);
                    var cx = p.context();
                    return findHead({ 'ref': 1, 'param':1 }, cx);
                }
            }
            stream.eatWhile(function() { return true });
            return 'error';
        }
    }
});

var mirror = CodeMirror(document.body,
    { onCursorActivity: function() { updateDebug() } });

var extend = function(a,b) {
    for_kv(b, function(k,v) {
        a[k] = v;
    });
    return a;
};

var unions = function(xs) {
    var r = {};
    foreach(xs, function(x) { extend(r,x) });
    return r;
};

var set = function() {
    var r = {};
    for (var i = 0; i < arguments.length; i++) {
        r[arguments[i]] = true;
    }
    return r;
};

var remove = function(key, s) {
    var r = extend({}, s);
    delete r[key];
    return r;
};

var updateDebug = function() {
    var tok = mirror.getTokenAt(mirror.getCursor());
    var cx = tok.state.state[0].context();
    var tree = build_zipper(cx);
    AttributeGrammar.install_zipper(cx, 'defined_vars', {
        'ROOT': function(node, children, parent) { return set() },
        '*': function(node, children, parent) { return parent.defined_vars() },
        'scope': function(node, children, parent) {
            if (children[1] && children[1].args[1]) {
                var u = unions([parent.defined_vars(), set(children[1].args[1])]);
                return u;
            }
            else {  
                return parent.defined_vars();
            }
        }
    });

    AttributeGrammar.install_root(tree, 'free_vars', {
        '*': function(node, children, parent) { 
            var fvs = {};
            foreach(children, function(child) {
                if (typeof(child) === 'object' && 'free_vars' in child) {
                    extend(fvs, child.free_vars());
                }
            });
            return fvs;
        },
        'scope': function(node, children, parent) {
            if (children[1] && children[1].args[1] && children[2]) {
                return remove(children[1].args[1], children[2].free_vars());
            }
            else {
                return children[2] ? children[2].free_vars() : set();
            }
        },
        'ref': function(node, children, parent) {
            return set(children[0]);
        }
    });

    $('#debug').text("Bound Variables: " + keys(cx[0].defined_vars()) + "\nFree Variables: " + keys(tree.free_vars()) + "\n");
};

});
</script>  
</head>
<body>
<pre id="debug" name="debug"></pre>
<button id="debugbtn" name="debugbtn">Debug</button>
</body>
</html>
