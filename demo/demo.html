<html>
<head> 
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="codemirror.js"></script>
<link rel="stylesheet" href="codemirror.css" />
<script src="../sexp.js"></script>
<script src="../earley.js"></script>
<script src="../attribute_grammar.js"></script>
<script src="../grammars/javascript.js"></script>

<style>
span.error        { background: red; color: white }
span.literal      { color: red; }
span.property_key { color: red; }
span.variable     { color: blue; }
</style>

<script>
$(function() { 

// CodeCatalog Snippet http://www.codecatalog.net/279/1/
var foreach = function(array, body) {
    for (var i = 0; i < array.length; ++i) {
        body(array[i]);
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/323/2/
var for_kv = function(object, body) {
    for (var k in object) {
        if (object.hasOwnProperty(k)) {
            body(k, object[k]);
        }
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/183/1/
var keys = function(obj) {
    var r = [];
    for (var key in obj) {
        r.push(key);
    }
    return r;
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/353/1/
var unique = function(l) {
    var r = [];
    var seen = {};
    for (var i = 0; i < l.length; i++) {
        if (!(l[i] in seen)) {
            r.push(l[i]);
            seen[l[i]] = true;
        }
    }
    return r; 
};
// End CodeCatalog Snippet

CodeMirror.defineMode("javascript", function(conifg, parserConfig) {
    var findHead = function(set, list) {
        for (var i = 0; i < list.length; i++) {
            if (list[i].head in set) return list[i].head;
        }
        return null;
    };

    return {
        startState: function() {
            return { state: EarleyParser(javascript_grammar, 'program') }
        },
        copyState: function(state) {
            return { state: state.state }
        },
        token: function(stream, state) {
            // munch longest token
            // if multiple, consume all
            // (going to bite)
            var best = { string: '', states: [] };
            for (var i = 0; i < state.state.tokens.length; ++i) {
                var p = state.state.tokens[i];
                var m = stream.match(p.symbol, false);
                if (m) {
                    if (m[0].length == best.string.length) {
                        best.states.push(p);
                    }
                    else if (m[0].length > best.string.length) {
                        best.string = m[0];
                        best.states = [p];
                    }
                }
            }

            if (best.states.length > 0) {
                stream.match(best.string);
                var cx = best.states[0].context();  // gotta pick sumfin (could cat all)
                var classes = unique(cx.map(function(x) { return x.head })).join(' ');
                state.state = state.state.advance(best.states.map(function(s) { 
                    return s.consume(best.string);
                }));
                return classes;
            }
            else {
                stream.eatWhile(function() { return true });
                return 'error';
            }
        }
    }
});

var mirror = CodeMirror(document.body);

});
</script>  
</head>
<body>
<pre id="debug" name="debug"></pre>
</body>
</html>
