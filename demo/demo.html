<html>
<head> 
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="codemirror.js"></script>
<link rel="stylesheet" href="codemirror.css" />
<script src="../sexp.js"></script>
<script src="../earley.js"></script>
<script src="../attribute_grammar.js"></script>

<style>
span.ref     { color: green }
span.param   { color: blue }
span.error   { background: red; color: white }
</style>

<script>
$(function() { 

// CodeCatalog Snippet http://www.codecatalog.net/279/1/
var foreach = function(array, body) {
    for (var i = 0; i < array.length; ++i) {
        body(array[i]);
    }
};
// End CodeCatalog Snippet

var grammar = {
    'E':       [ [ 'stmts' ] ],
    'stmts':   [ [ 'stmt', /^;/, 'stmts' ], [ ] ],
    'stmt':    [ [ 'scope' ], [ 'ref' ] ],
    'scope':   [ [ /^\{/, 'param', 'stmts', /^\}/ ] ],
    'param':   [ [ ], [ /^\|/, /^\w+/, /^\|/ ] ],
    'ref':     [ [ /^\w+/ ] ],
};

CodeMirror.defineMode("alty", function(conifg, parserConfig) {
    var findHead = function(set, list) {
        for (var i = 0; i < list.length; i++) {
            if (list[i].head in set) return list[i].head;
        }
        return null;
    };

    return {
        startState: function() {
            return { state: EarleyParser(grammar, 'E') }
        },
        copyState: function(state) {
            return { state: state.state }
        },
        token: function(stream, state) {
            for (var i = 0; i < state.state.length; ++i) {
                var p = state.state[i];
                var m = stream.match(p.symbol);
                if (m) {
                    state.state = p.consume(m[0]);
                    var cx = p.context();
                    return findHead({ 'ref': 1, 'param':1 }, cx);
                }
            }
            stream.eatWhile(function() { return true });
            return 'error';
        }
    }
});

var mirror = CodeMirror(document.body);

$('#debugbtn').click(function() {
    var tok = mirror.getTokenAt(mirror.getCursor());
    $('#debug').text(tok.state.state.map(function(s) { return s.context().join("\n") }).join("\n--------\n"));
});

});
</script>  
</head>
<body>
<pre id="debug" name="debug"></pre>
<button id="debugbtn" name="debugbtn">Debug</button>
</body>
</html>
