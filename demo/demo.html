<html>
<head> 
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="codemirror.js"></script>
<link rel="stylesheet" href="codemirror.css" />
<script src="../sexp.js"></script>
<script src="../earley.js"></script>
<script src="../attribute_grammar.js"></script>
<script src="../grammars/javascript.js"></script>

<style>
span.error       { background: red; color: white }
span.initializer { font-weight: bold }
</style>

<script>
$(function() { 

// CodeCatalog Snippet http://www.codecatalog.net/279/1/
var foreach = function(array, body) {
    for (var i = 0; i < array.length; ++i) {
        body(array[i]);
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/323/2/
var for_kv = function(object, body) {
    for (var k in object) {
        if (object.hasOwnProperty(k)) {
            body(k, object[k]);
        }
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/183/1/
var keys = function(obj) {
    var r = [];
    for (var key in obj) {
        r.push(key);
    }
    return r;
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/353/1/
var unique = function(l) {
    var r = [];
    var seen = {};
    for (var i = 0; i < l.length; i++) {
        if (!(l[i] in seen)) {
            r.push(l[i]);
            seen[l[i]] = true;
        }
    }
    return r; 
};
// End CodeCatalog Snippet

CodeMirror.defineMode("javascript", function(conifg, parserConfig) {
    var findHead = function(set, list) {
        for (var i = 0; i < list.length; i++) {
            if (list[i].head in set) return list[i].head;
        }
        return null;
    };

    return {
        startState: function() {
            return { state: EarleyParser(javascript_grammar, 'program') }
        },
        copyState: function(state) {
            return { state: state.state }
        },
        token: function(stream, state) {
            for (var i = 0; i < state.state.length; ++i) {
                var p = state.state[i];
                var m = stream.match(p.symbol);
                if (m) {
                    state.state = p.consume(m[0]);
                    var cx = p.context();
                    return unique(cx.map(function(x) { return x.head })).join(' ');
                }
            }
            stream.eatWhile(function() { return true });
            return 'error';
        }
    }
});

var mirror = CodeMirror(document.body);

});
</script>  
</head>
<body>
<pre id="debug" name="debug"></pre>
</body>
</html>
