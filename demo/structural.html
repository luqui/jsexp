<html>
 <head>
  <script src="jquery.min.js"></script>
  <script src="../StructuralFramework.js"></script>

  <style>
   .eatom { color: red }
   .selected { background: #fdd }
   .box { background: lightgreen }
  </style>

  <script>

var main = function($, SF) {

// CodeCatalog Snippet http://www.codecatalog.net/323/2/
var for_kv = function(object, body) {
    for (var k in object) {
        if (object.hasOwnProperty(k)) {
            body(k, object[k]);
        }
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/378/2/
var regexp_tokenizer = function(tokens) { 
    return function(str) {
        var bestMatch = null;
        var bestFunc = null; 
        for_kv(tokens, function(k,v) {
            var m = new RegExp('^' + k)(str);
            if (m && (!bestMatch || m[0].length > bestMatch[0].length)) {
                bestMatch = m;
                bestFunc = v;
            }
        });

        // don't match the whole string in case we are in the middle of typing a token
        // we use \0 to mean "eof" so this will pass.
        if (bestFunc && bestMatch[0].length < str.length) {
            return [bestFunc(bestMatch), str.slice(bestMatch[0].length)];
        }
        else {
            return null;
        }
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/256/1/
var text_node = function(text) { return document.createTextNode(text) };
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/16/3/
var elt = function(name, attrs) {
    var r = $(document.createElement(name));
    if (attrs) {
        for (var i in attrs) {
            r.attr(i, attrs[i]);
        }
    }
    for (var i = 2; i < arguments.length; ++i) {
        r.append(arguments[i]);
    }
    return r;
};
// End CodeCatalog Snippet

var Exp_eplus_box = SF.Infix_assoc_box('eplus', 
    'eatom', regexp_tokenizer({
        '\\d+': function(m) {
            return Exp_eatom.make(m[0]);
        }
    }),
    'plus_token', regexp_tokenizer({
        '\\+': function(m) {
            return Exp_plus_token.make()
        }
    }));

var Exp_plus_token = new SF.EClass({
    cls: 'plus_token',
    render: function() {
        return [text_node(' + ')]
    }
});

var Exp_eatom = new SF.EClass({
    cls: 'eatom'
});



var container = elt('div');
$(document.body).append(container);

var buffer = '';

var zipper = new SF.Zipper([], Exp_eplus_box.make());

var update = function(z) {
    if (!z) return;
    zipper = z;
    container.empty();
    container.append(elt('pre', {}, SF.render_zipper_with(z, function(t) { 
        return elt('span', {'class': 'selected'}, t, text_node(buffer)) 
    })));
};

update(zipper);

$(document.body).keydown(function(e) {
    var head = typeof(zipper.expr) === 'string' ? new SF.EClass({}) : zipper.expr.head;

    var navigate = function(dir) {
        buffer = '';
        update(head[dir].call(head, zipper));
    };

    if (37 == e.which) { // left
        navigate('nav_left');
    }
    else if (38 == e.which) { // up
        navigate('nav_up');
    }
    else if (39 == e.which) { // right
        navigate('nav_right');
    }
    else if (40 == e.which) { // down
        navigate('nav_down');
    }
    else if (8 == e.which) { // backspace
        buffer = buffer.slice(0, buffer.length-1);
        update(zipper);
        return false;  // prevent browser from handling it
    }
    else {
        //console.log(e.which, e.charCode);
    }
});


$(document.body).keypress(function(e) {
    if (typeof(zipper.expr) !== 'string') {
        var ch = String.fromCharCode(e.charCode);
        buffer += ch;
        var tokresult = zipper.expr.head.parse(zipper.expr)(buffer);
        if (tokresult) {
            buffer = tokresult[1];
            update(new SF.Zipper(zipper.contexts, tokresult[0]));
        }
        else {
            update(zipper);
        }
    }
    return false;
});

};

jQuery(function() {
    main(jQuery, StructuralFramework(jQuery));
});


  </script>
 </head>
 <body>
 </body>
</html>
