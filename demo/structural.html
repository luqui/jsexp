<html>
 <head>
  <script src="jquery.min.js"></script>
  <script src="../structural.js"></script>

  <style>
   .eatom { color: red }
   .selected { background: #fdd }
  </style>

  <script>
$(function() {

var container = elt('div');
$(document.body).append(container);

var update = function(z) {
    container.empty();
    container.append(elt('pre', {}, render_zipper(z)));
};

var parser = {
    tokenizer: map_tokenizer(flatten, multi_tokenizer(regexp_tokenizer({
        '\\d+': function(m) { return [Exp_eatom.make(m[0])] },
        '\\s+': function(m) { return [] },
        '\\+': function() { return [Exp_plus_token.make()] }
    }))),
    parser: rewrite_parser({
        'eatom': function(eatom) { return Exp_eplus_single.make(eatom) },
        'eplus plus_token eatom': function(eplus, plus_token, eatom) {
            return Exp_eplus.make(eplus, plus_token, eatom);
        }
    })
};

var zipper = new Zipper([], Exp_unassembled(parser).make());

update(zipper);

var unfocus = function() {
    if (typeof(zipper.expr) !== 'string' && zipper.expr.head.unfocus) {     
        zipper = zipper.expr.head.unfocus(zipper) 
    }
};

$(document.body).keydown(function(e) {
    if (37 == e.which) { // left
        unfocus();
        update(zipper = zipper.left());
    }
    else if (38 == e.which) { // up
        unfocus();
        update(zipper = zipper.up());
    }
    else if (39 == e.which) { // right
        unfocus();
        update(zipper = zipper.right());
    }
    else if (40 == e.which) { // down
        unfocus();
        update(zipper = zipper.down(0));
    }
    else {
        console.log(e.which, e.charCode);
    }
});

$(document.body).keypress(function(e) {
    if (typeof(zipper.expr) !== 'string' && zipper.expr.head.keypress) {
        update(zipper = zipper.expr.head.keypress(String.fromCharCode(e.charCode), zipper));
    }
    else {
        var cmd = String.fromCharCode(e.charCode);
        if (cmd == 'a') {
            update(zipper = new Zipper(zipper.contexts, Exp_unassembled(parser).make(zipper.expr)));
        }
        if (cmd == 'c') {
            update(zipper = new Zipper(zipper.contexts, Exp_unassembled(parser).make()));
        }
    }
});

});
  </script>
 </head>
 <body>
 </body>
</html>
