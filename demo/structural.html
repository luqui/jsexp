<html>
 <head>
  <script src="jquery.min.js"></script>
  <script src="../structural.js"></script>

  <style>
   .eatom { color: red }
   .selected { background: #fdd }
   .box { background: lightgreen }
  </style>

  <script>
$(function() {

var Exp_eplus_box = Infix_assoc_box('eplus', 
    'eatom', regexp_tokenizer({
        '\\d+': function(m) {
            return Exp_eatom.make(m[0]);
        }
    }),
    'plus_token', regexp_tokenizer({
        '\\+': function(m) {
            return Exp_plus_token.make()
        }
    }));

var Exp_plus_token = new EClass({
    cls: 'plus_token',
    render: function() {
        return [text_node(' + ')]
    }
});

var Exp_eatom = new EClass({
    cls: 'eatom'
});



var container = elt('div');
$(document.body).append(container);

var buffer = '';

var zipper = new Zipper([], Exp_eplus_box.make());

var update = function(z) {
    if (!z) return;
    zipper = z;
    container.empty();
    container.append(elt('pre', {}, render_zipper_with(z, function(t) { 
        return elt('span', {'class': 'selected'}, t, text_node(buffer)) 
    })));
};

update(zipper);

$(document.body).keydown(function(e) {
    var head = typeof(zipper.expr) === 'string' ? new EClass({}) : zipper.expr.head;

    var navigate = function(dir) {
        buffer = '';
        update(head[dir].call(head, zipper));
    };

    if (37 == e.which) { // left
        navigate('nav_left');
    }
    else if (38 == e.which) { // up
        navigate('nav_up');
    }
    else if (39 == e.which) { // right
        navigate('nav_right');
    }
    else if (40 == e.which) { // down
        navigate('nav_down');
    }
    else if (8 == e.which) { // backspace
        buffer = buffer.slice(0, buffer.length-1);
        update(zipper);
        return false;  // prevent browser from handling it
    }
    else {
        //console.log(e.which, e.charCode);
    }
});


$(document.body).keypress(function(e) {
    if (typeof(zipper.expr) !== 'string') {
        var ch = String.fromCharCode(e.charCode);
        buffer += ch;
        var tokresult = zipper.expr.head.parse(zipper.expr)(buffer);
        if (tokresult) {
            buffer = tokresult[1];
            update(new Zipper(zipper.contexts, tokresult[0]));
        }
        else {
            update(zipper);
        }
    }
    return false;
});

});
  </script>
 </head>
 <body>
 </body>
</html>
